---
title: "InitialAnalysis"
author: "Omprakash Samudrala"
date: "April 17, 2018"
output: html_document
---

## Initial Analysis

12 Data Sets from Process Flow DP tests on each RPX are added to the data folder of the project.

Data Sets contain 18 parameters of interest - 12 RPX pressure drops, Inlet & Outlet Manifold pressure drops, Inlet Pressure, Outlet Pressure, Global pressure drop and Process Flow Rate

Objectives

* Perform data scaling/offset to convert DAQ output to real units
* Step wise linear regression to obtain best fit parameter values at each step
* RPX pressure drop vs process flow rate model development
* Determine Flow Coefficient & Pressure Loss Coefficient for RPX 


```{r, results='hide'}

# Read Data
setwd("C:/Users/ompra/Documents/ProjectTemplate/RPXFlows/data")
library(openxlsx)
read.xlsx("Test1_AllData.xlsx")
TData <- read.xlsx("Test1_AllData.xlsx")
nRows <- nrow(TData)
nPX <- 1 # Single RPX that is running
nParams <- 18 # Number of parameters of interest

# Apply correct scaling & offset to convert DAQ data to real units
WrScale<-c(6.251,6.254,6.251,6.248,6.252,6.246,6.253,6.245,6.245,6.245,6.249,
           6.255,6.246,6.247)
WrOffset<-c(14.2,14.2,14.1,14.1,14.1,14.2,14.1,14.1,14.4,14.2,14.3,14.2,14.1,
            14.2)
WrAmpCrAmpRatio<-0.566482
CrScale<-c(6.2522,6.2547,6.2518,6.2493,6.2523,6.2461,6.2538,6.2451,6.2461,
          6.2455,6.2496,6.2554,6.2473,6.2474)
CrOffset<-c(-25.2216,-25.1320,-25.0128,-25.033,-24.9001,-24.9437,-25.03861,
            -25.0429,-25.3746,-25.1746,-25.2732,-25.0707,-25.1623,-24.8397)

for(i in 2:15){
  for(j in 1:nRows){
    TData[j,i]<-(TData[j,i]+WrOffset[i-1])/WrScale[i-1]/WrAmpCrAmpRatio
    TData[j,i]<-TData[j,i]*CrScale[i-1]+CrOffset[i-1]
  }
}

#Change Labels of some columns & append LPFlow, LPInPr & Global_LPDP
colnames(TData)[14] <- "InMan_LPDP"
colnames(TData)[15] <- "OutMan_LPDP"
colnames(TData)[18] <- "LPFlow_EvenPX"
colnames(TData)[19] <- "LPFlow_OddPX"
TData$LPFlow <- TData$LPFlow_EvenPX + TData$LPFlow_OddPX
colnames(TData)[26] <- "LPInPr_EvenPX"
colnames(TData)[27] <- "LPInPr_OddPX"
TData$LPInPr <- TData$LPInPr_EvenPX + TData$LPInPr_OddPX
colnames(TData)[28] <- "LPOutPr"
TData$Global_LPDP <- TData$LPInPr - TData$LPOutPr
TData$InMan_LPDP <- -TData$InMan_LPDP
TData$OutMan_LPDP <- -TData$OutMan_LPDP

#Plot LPFlow vs Time. Process Flow Rate was increased in steps
library(ggplot2)
ggplot(data=TData,aes(x=Time, y=LPFlow)) + geom_point() + ylab("LPFlow (GPM)")

#Remove Transient Data
LPFlowStepMin <- c(137,188,229,272,316,349,363)
LPFlowStepMax <- c(145,194,234,278,322,355,368)
nStep <- length(LPFlowStepMin)

#TDataPick <- rep(NULL, length(colnames(TData)))
TDataPick <- NULL
nData <- NULL
for (i in 1:nStep){
  FilterData <- TData[TData$LPFlow>LPFlowStepMin[i] & TData$LPFlow<LPFlowStepMax[i],]
  nData[i] <- nrow(FilterData)
  TDataPick <- rbind(TDataPick,FilterData)
}

#Stepwise Linear Regression for Desired Variables
FitDataPick <- matrix(rep(0,nParams*nStep),nParams,nStep)
nStart <- 1
for (i in 1:nStep){
  nEnd <- nStart + nData[i]-1
  FitDataPick[nParams,i]<-mean(TDataPick$LPFlow[nStart:nEnd])
  nStart <- nEnd+1
}

DesiredCols <- c(2:15,50,28,51,49)

for (i in 1:(nParams-1)){
  nStart <- 1
  for (j in 1:nStep){
    nEnd <- nStart + nData[j]-1
    x<-TDataPick[nStart:nEnd,DesiredCols[nParams]]
    y<-TDataPick[nStart:nEnd,DesiredCols[i]]
    relation <- lm(y~x)
    FitDataPick[i,j]<-relation$coefficients[1]+relation$coefficients[2]*
      FitDataPick[nParams,j]
    nStart <- nEnd+1
  }
}

# Non-linear regression for pressure loss curve
varA<-0
varB<-0
npts<-0
for (ii in 1:nStep){
  varA <- varA+FitDataPick[nPX,ii]*FitDataPick[nParams,ii]^2
  varB <- varB+FitDataPick[nParams,ii]^4
  npts <- npts+nData[ii]
}
FitCoeff <- varA/varB
FlowCoeff <- 1/sqrt(FitCoeff)
PrLossCoeff <- 2*FitCoeff*(pi/4*1.75^2)^2/62.4*32.17605*12^4/3.85^2

FitData <- rep(0, 2*90)
FitData <- matrix(FitData,90,2)
for (ii in 1:90){
  FitData[ii,1] <- 0+(ii-1)*5
  FitData[ii,2] <- FitCoeff*FitData[ii,1]^2
}
FitData <- data.frame(FitData)
is.data.frame(FitData)
colnames(FitData) <- c("LPFlow","LPDP")
colnames(FitData)

PlotData <- rep(0, 2*npts)
PlotData <- matrix(PlotData,npts,2)
ii<-0
for (jj in 1:nStep){
  for (kk in 1:nData[jj]){
    ii <- ii+1
    PlotData[ii,1]<-TDataPick[ii,nPX+1]
    PlotData[ii,2]<-TDataPick[ii,49]
  }
}
PlotData <- data.frame(PlotData)
colnames(PlotData) <- c("LPDP","LPFlow")
str(PlotData)

ggplot(data=PlotData,aes(x=LPFlow,y=LPDP)) + geom_point()

ggplot(data=FitData,aes(x=LPFlow,y=LPDP)) + geom_smooth()

```

## Work in Progress